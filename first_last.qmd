---
title: "first and last year"
format: html
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: load-libraries
#| message: false
library(lme4)
library(glmnet)
library(pROC)
library(tidymodels)
library(rsample)
library(themis)
library(caret)
library(performance)
library(DHARMa)
library(kableExtra)
library(broom.mixed)
library(tidyverse)
```

```{r}
df <- readRDS("data/model_df.rds")

df_2015 <- df |>
  filter(year_enrolled == "2015-2016") |>
  dplyr::select(-c(term_enrolled, course_ID, estimated, 
                   did_indep_study, student_group, year_enrolled, 
                   max_units, final_grade, timeperiod))

df_2024 <- df |>
  filter(year_enrolled == "2024-2025") |>
  dplyr::select(-c(term_enrolled, course_ID, estimated, 
                   did_indep_study, student_group, year_enrolled, 
                   max_units, final_grade, timeperiod))
```

## Train Test Split

```{r}
#| label: train-test-split
set.seed(123)

split <- group_initial_split(df_2015, group = masked_student_ID, prop = 0.8)
train_2015 <- training(split)
test_2015  <- testing(split)

split <- group_initial_split(df_2024, group = masked_student_ID, prop = 0.8)
train_2024 <- training(split)
test_2024  <- testing(split)
```

```{r}
best_hyperparam <- readRDS("data/best_hyperparam.rds")
best_thresh <- readRDS("data/best_thresh.rds")
selected_vars <- readRDS("data/selected_vars.rds")
```

```{r}
selected <- setdiff(selected_vars, c("term_units", "actual_units", 
                                     "timeperiod_1", "timeperiod_2"))

glm_formula <- as.formula(
  paste0("is_SU ~ ", paste(selected, collapse = " + "), 
         " + (1 | masked_student_ID)")
)

glmer_2015 <- recipe(is_SU ~ ., data = train_2015) |>
  update_role(masked_student_ID, new_role = "id") |>
  step_impute_median(all_numeric_predictors()) |>
  step_impute_mode(all_nominal_predictors()) |>
  step_mutate(across(where(is.logical), as.factor)) |>
  step_dummy(all_nominal_predictors(), -all_outcomes(), 
             -masked_student_ID, one_hot = TRUE) |>
  step_interact(
    terms = ~ is_natural_sci:starts_with("division_") +
             is_art_humanity:starts_with("division_") +
             is_social_sci:starts_with("division_")
  ) |>
  step_zv(all_predictors()) |>
  step_normalize(all_numeric_predictors()) |>
  step_smote(is_SU, over_ratio = best_hyperparam$over_ratio)

trained_2015 <- prep(glmer_2015, retain = TRUE)
glmer_2015 <- bake(trained_2015, new_data = NULL)

glmer_fit_2015 <- glmer(
  glm_formula,
  data = glmer_2015,
  family = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa", calc.derivs = FALSE)
)

model_tidy_2015 <- tidy(glmer_fit_2015, effects = "fixed", conf.int = TRUE) |>
  select(-effect)
kable(model_tidy_2015, digits = 3, caption = "GLMM Fixed Effects") |>
  kable_styling(full_width = FALSE) |>
  column_spec(1, width = "10em", 
              extra_css = "word-wrap: break-word; white-space: normal;")
```

```{r}
glmer_2024 <- recipe(is_SU ~ ., data = train_2024) |>
  update_role(masked_student_ID, new_role = "id") |>
  step_impute_median(all_numeric_predictors()) |>
  step_impute_mode(all_nominal_predictors()) |>
  step_mutate(across(where(is.logical), as.factor)) |>
  step_dummy(all_nominal_predictors(), -all_outcomes(), 
             -masked_student_ID, one_hot = TRUE) |>
  step_interact(
    terms = ~ is_natural_sci:starts_with("division_") +
             is_art_humanity:starts_with("division_") +
             is_social_sci:starts_with("division_")
  ) |>
  step_zv(all_predictors()) |>
  step_normalize(all_numeric_predictors()) |>
  step_smote(is_SU, over_ratio = best_hyperparam$over_ratio)

trained_2024 <- prep(glmer_2024, retain = TRUE)
glmer_2024 <- bake(trained_2024, new_data = NULL)

glmer_fit_2024 <- glmer(
  glm_formula,
  data = glmer_2024,
  family = binomial(link = "logit"),
  control = glmerControl(optimizer = "bobyqa", calc.derivs = FALSE)
)

model_tidy_2024 <- tidy(glmer_fit_2024, effects = "fixed", conf.int = TRUE) |>
  select(-effect)
kable(model_tidy_2024, digits = 3, caption = "GLMM Fixed Effects") |>
  kable_styling(full_width = FALSE) |>
  column_spec(1, width = "10em", 
              extra_css = "word-wrap: break-word; white-space: normal;")
```

```{r}
# ---- Extract means and SDs from the 2015 recipe ----
step_idx_2015 <- which(sapply(trained_2015$steps, inherits, what = "step_normalize"))
norm_step_2015 <- trained_2015$steps[[step_idx_2015]]

means_2015 <- norm_step_2015$means
sds_2015   <- norm_step_2015$sds


# ---- Extract means and SDs from the 2024 recipe ----
step_idx_2024 <- which(sapply(trained_2024$steps, inherits, what = "step_normalize"))
norm_step_2024 <- trained_2024$steps[[step_idx_2024]]

means_2024 <- norm_step_2024$means
sds_2024   <- norm_step_2024$sds

unscaled_2015 <- model_tidy_2015
unscaled_2024 <- model_tidy_2024

# Add a new column
unscaled_2015$estimate_unscaled <- unscaled_2015$estimate

for (v in names(sds_2015)) {
  unscaled_2015$estimate_unscaled[unscaled_2015$term == v] <-
    unscaled_2015$estimate[unscaled_2015$term == v] / sds_2015[v]
}

interaction_rows_2015 <- grep(":", unscaled_2015$term)

for (i in interaction_rows_2015) {
  term <- unscaled_2015$term[i]
  parts <- strsplit(term, ":")[[1]]

  mult <- 1
  for (p in parts) {
    if (p %in% names(sds_2015)) {
      mult <- mult * (1 / sds_2015[p])
    }
  }

  unscaled_2015$estimate_unscaled[i] <- unscaled_2015$estimate[i] * mult
}
```

```{r}
unscaled_2024$estimate_unscaled <- unscaled_2024$estimate

for (v in names(sds_2024)) {
  unscaled_2024$estimate_unscaled[unscaled_2024$term == v] <-
    unscaled_2024$estimate[unscaled_2024$term == v] / sds_2024[v]
}

interaction_rows_2024 <- grep(":", unscaled_2024$term)

for (i in interaction_rows_2024) {
  term <- unscaled_2024$term[i]
  parts <- strsplit(term, ":")[[1]]

  mult <- 1
  for (p in parts) {
    if (p %in% names(sds_2024)) {
      mult <- mult * (1 / sds_2024[p])
    }
  }

  unscaled_2024$estimate_unscaled[i] <- unscaled_2024$estimate[i] * mult
}

```

```{r}
coef_compare <- unscaled_2015[, c("term", "estimate_unscaled")] |>
  rename(est_2015 = estimate_unscaled) |>
  inner_join(
    unscaled_2024[, c("term", "estimate_unscaled")] |>
      rename(est_2024 = estimate_unscaled),
    by = "term"
  ) |>
  mutate(diff = est_2024 - est_2015) |>
  arrange(desc(abs(diff)))   # optional sort by size of change

kable(coef_compare, digits = 3,
      caption = "Unscaled Coefficient Differences (2024 âˆ’ 2015)") |>
  kable_styling(full_width = FALSE) |>
  column_spec(1, width = "10em", 
              extra_css = "word-wrap: break-word; white-space: normal;")

```

